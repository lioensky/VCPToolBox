# TagMemo “浪潮”算法 (V4 alpha 内测中) 深度技术文档

## 1. 算法概述
TagMemo “浪潮”算法（TagMemo Wave Algorithm）是 VCP 系统中用于 RAG（检索增强生成）的核心优化方案。
V4 版本引入了**语义分段 (Semantic Segmentation)**、**霰弹枪查询 (Shotgun Query)** 和 **SVD智能去重 (Latent Topic Deduplication)**，进一步解决了长上下文中的"语义稀释"问题，实现了对复杂对话流的多点精准召回。

## 2. 核心哲学：语义引力与向量重塑
在浪潮算法的视角下，向量空间并非平坦的，而是充满了语义引力。
*   **语义锚点**：标签（Tags）被视为空间中的引力源。
*   **向量重塑**：算法不直接使用原始查询向量，而是根据感应到的标签引力，将向量向核心语义点进行“拉扯”和“扭曲”，从而在检索时能够穿透表层文字，直达语义核心。

## 3. 核心模块架构

### 3.1 EPA 模块 (Embedding Projection Analysis)
[`EPAModule.js`](EPAModule.js) 负责语义空间的初步定位。
*   **逻辑深度 (Logic Depth)**：通过计算投影熵值，判断用户意图的聚焦程度。
*   **世界观门控 (Worldview Gating)**：识别当前对话所处的语义维度（如技术、情感、社会等）。
*   **跨域共振 (Resonance)**：检测用户是否同时触及了多个正交的语义轴，决定检索的广度。

### 3.2 残差金字塔 (Residual Pyramid)
[`ResidualPyramid.js`](ResidualPyramid.js) 是算法的“数学心脏”，负责语义能量的精细拆解。
*   **多级剥离**：利用 **Gram-Schmidt 正交化投影**，将查询向量分解为“已解释能量”和“残差能量”。
*   **微弱信号捕获**：通过对残差向量的递归搜索，捕捉那些被宏观概念掩盖的微弱语义信号。
*   **相干性分析 (Coherence)**：评估召回标签之间的逻辑一致性，决定“浪潮”的激活强度。

### 3.3 知识库管理器 (KnowledgeBaseManager)
[`KnowledgeBaseManager.js`](KnowledgeBaseManager.js) 负责标签的召回与向量合成。
*   **核心标签 (CoreTags)**：拥有“虚拟召回”和“权重豁免”特权，作为语义的绝对锚点。
*   **逻辑拉回 (Logic Pull-back)**：利用标签共现矩阵，自动联想并拉回与当前主题强相关的逻辑词。
*   **语义去重**：消除冗余标签，确保召回信息的多样性。

### 3.4 偏振语义舵 (Polarization Semantic Rudder, PSR)
[`RAGDiaryPlugin.js`](Plugin/RAGDiaryPlugin/RAGDiaryPlugin.js) 中的核心工程化函数。
*   **犹豫度检测 (Hesitation Detection)**：利用 NLP 解析识别输入输出中的转折与摇摆成分。
*   **动态偏振算法 (Dynamic Polarization)**：物理动态化语义向量在投影上的摆动程度。
*   **辩证对冲**：在召回阶段引入“同类知识”的“负向对冲知识”，构建辩证认知。

### 3.5 结果去重器 (ResultDeduplicator)
[`ResultDeduplicator.js`](ResultDeduplicator.js) 是 V4 新增的"智能过滤器"。
*   **SVD 主题建模**：对"霰弹枪"检索回来的海量结果进行 SVD 分解，识别出本次检索的 n 个潜在主题 (Latent Topics)。
*   **残差选择 (Residual Selection)**：使用 Gram-Schmidt 正交化，迭代选择能解释"未覆盖主题能量"的最佳结果。该机制确保了检索结果的多样性，既能覆盖主要意图，又能保留那些微弱但独特的重要信息 (Weak Links)，同时彻底消除语义重复的冗余条目。

## 4. 详细工作流

### 阶段一：感应 (Sensing)
1.  **净化处理**：移除 HTML标签、json结构化转md、Emoji 及工具调用标记（Tool Markers），消除技术噪音。
2.  **EPA 投影**：计算原始向量的逻辑深度和共振值，确定初始语义坐标。

### 阶段二：分段与分解 (Segmentation & Decomposition)
1.  **语义分段**：`ContextVectorManager` 扫描历史上下文，基于向量相似度（阈值 0.70）将连续对话流切割为独立的语义段落 (Topics)。
2.  **首轮感应**：使用当前查询向量投射 Tag 向量海，获取最强匹配标签 (CoreTag)。
3.  **金字塔迭代**：对当前向量进行残差分解，挖掘深层标签。

### 阶段三：扩张与召回 (Expansion & Recall)
1.  **核心标签补全**：若显式指定的核心标签未被搜到，强行从数据库捞取其向量。
2.  **关联词拉回**：根据共现矩阵，从高权重标签扩展出关联语义。
3.  **特权过滤**：核心标签无条件保留，普通标签需通过世界观门控筛选。

### 阶段四：重塑与检索 (Reshaping & Retrieval)
1.  **动态参数计算**：
    *   **Beta (TagWeight)**：根据逻辑深度和共振值动态决定标签增强的比例。
    *   **K 值调整**：根据信息量动态决定检索片段的数量。
2.  **向量融合**：将原始向量与增强标签向量按动态比例混合，实现“语义坍缩”。
3.  **偏振修正 (PSR Correction)**：
    *   检测上下文中的语义偏振信号。
    *   若触发犹豫机制，计算偏振向量投影。
    *   根据偏振强度，计算对冲检索参数。
4.  **霰弹枪检索与相控阵去重 (Shotgun & Deduplication)**：
    *   **霰弹枪发射**：并行执行 N+1 次检索（1次当前向量 + N次历史分段向量），最大限度覆盖长上下文中的所有潜在关注点。
    *   **SVD 建模**：对汇聚的数百条候选结果进行 SVD 分析，提取潜在主题。
    *   **残差去重**：迭代选择最具信息增量的结果，形成最终的精简结果集（通常为 Top K）。
    *   **对冲召回**：若偏振触发，同步混入对冲检索结果。

## 5. 工程原理亮点

### 5.1 核心标签 vs. 普通标签
| 特性 | 核心标签 (Core Tags) | 普通标签 (Other Tags) |
| :--- | :--- | :--- |
| **产生方式** | 显式指定或首轮强感应 | 残差金字塔逐层剥离 |
| **缺失处理** | **虚拟补全**（强行捞取） | 自动忽略 |
| **权重待遇** | **Core Boost** (1.2x-1.4x) | 原始贡献权重 |
| **噪音过滤** | **完全豁免** | 严格门控筛选 |

### 5.2 动态 Beta 公式
[`RAGDiaryPlugin.js`](Plugin/RAGDiaryPlugin/RAGDiaryPlugin.js) 中算法通过以下公式实现能量平衡：
`β = σ(L · log(1 + R) - S · noise_penalty)`
该公式确保了：当用户意图明确（L高）且逻辑清晰（R高）时，算法会加大标签增强力度；当噪音较多（S高）时，则收紧增强，回归稳健检索。

### 5.3 噪音净化器 (Sanitizer)
为了防止 AI 的技术标记干扰向量搜索，算法实现了专门的工具调用净化逻辑，确保向量化的是纯粹的“人类语义”，而非“机器指令”。

### 5.4 辩证认知器 (Dialectical Cognitizer)
V4 版本引入的 PSR 机制本质上是一个可量化、可控制的辩证认知器。它不再盲目追求语义的绝对一致性，而是通过捕捉人类思维中的“犹豫”与“摇摆”，主动提供对冲信息，从而打破 AI 的“回声壁垒”，实现更深层次的逻辑闭环。

## 6. 结论
TagMemo 浪潮算法通过对语义能量的物理级模拟，解决了传统 RAG 在处理复杂意图时容易“跑题”或“漏掉细节”的问题。它不仅是一套检索技术，更是一套对人类语言逻辑进行深度建模的工程实践。尤其是在 V4 中通过“偏振语义舵”实现了从线性检索到辩证召回的跨越。它不仅能精准捕捉用户的显性意图，更能通过物理动态化语义投影，洞察并回应用户思维中的隐性摇摆，为 RAG 系统注入了真正的辩证思考能力。