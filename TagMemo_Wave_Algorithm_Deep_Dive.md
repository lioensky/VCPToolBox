# TagMemo “浪潮”算法 (V4 alpha 内测中) 深度技术文档

## 1. 算法概述
TagMemo “浪潮”算法（TagMemo Wave Algorithm）是 VCP 系统中用于 RAG（检索增强生成）的核心优化方案。不同于传统的线性向量检索，浪潮算法引入了物理学中的**能量分解**与**引力坍缩**概念，通过对用户意图进行多维度的语义重塑，实现“原子级”的精准记忆召回。

## 2. 核心哲学：语义引力与向量重塑
在浪潮算法的视角下，向量空间并非平坦的，而是充满了语义引力。
*   **语义锚点**：标签（Tags）被视为空间中的引力源。
*   **向量重塑**：算法不直接使用原始查询向量，而是根据感应到的标签引力，将向量向核心语义点进行“拉扯”和“扭曲”，从而在检索时能够穿透表层文字，直达语义核心。

## 3. 核心模块架构

### 3.1 EPA 模块 (Embedding Projection Analysis)
[`EPAModule.js`](EPAModule.js) 负责语义空间的初步定位。
*   **逻辑深度 (Logic Depth)**：通过计算投影熵值，判断用户意图的聚焦程度。
*   **世界观门控 (Worldview Gating)**：识别当前对话所处的语义维度（如技术、情感、社会等）。
*   **跨域共振 (Resonance)**：检测用户是否同时触及了多个正交的语义轴，决定检索的广度。

### 3.2 残差金字塔 (Residual Pyramid)
[`ResidualPyramid.js`](ResidualPyramid.js) 是算法的“数学心脏”，负责语义能量的精细拆解。
*   **多级剥离**：利用 **Gram-Schmidt 正交化投影**，将查询向量分解为“已解释能量”和“残差能量”。
*   **微弱信号捕获**：通过对残差向量的递归搜索，捕捉那些被宏观概念掩盖的微弱语义信号。
*   **相干性分析 (Coherence)**：评估召回标签之间的逻辑一致性，决定“浪潮”的激活强度。

### 3.3 知识库管理器 (KnowledgeBaseManager)
[`KnowledgeBaseManager.js`](KnowledgeBaseManager.js) 负责标签的召回与向量合成。
*   **核心标签 (CoreTags)**：拥有“虚拟召回”和“权重豁免”特权，作为语义的绝对锚点。
*   **逻辑拉回 (Logic Pull-back)**：利用标签共现矩阵，自动联想并拉回与当前主题强相关的逻辑词。
*   **语义去重**：消除冗余标签，确保召回信息的多样性。

### 3.4 偏振语义舵 (Polarization Semantic Rudder, PSR)
[`RAGDiaryPlugin.js`](Plugin/RAGDiaryPlugin/RAGDiaryPlugin.js) 中的核心工程化函数。
*   **犹豫度检测 (Hesitation Detection)**：利用 NLP 解析识别输入输出中的转折与摇摆成分（如“虽然...但是...”、“是这样...但如果...”）。
*   **动态偏振算法 (Dynamic Polarization)**：通过高级分段器与分段向量算法，物理动态化语义向量在投影上的摆动程度，量化语义的“犹豫程度”。
*   **辩证对冲 (Dialectical Hedging)**：根据偏振量化值，在召回阶段引入“同类知识”的“负向对冲知识/日记”，构建辩证认知。

## 4. 详细工作流

### 阶段一：感应 (Sensing)
1.  **净化处理**：移除 HTML标签、json结构化转md、Emoji 及工具调用标记（Tool Markers），消除技术噪音。
2.  **EPA 投影**：计算原始向量的逻辑深度和共振值，确定初始语义坐标。

### 阶段二：分解 (Decomposition)
1.  **首轮感应**：使用融合向量投射Tag向量海，获取最强匹配标签(CoreTag)。
2.  **金字塔迭代**：
    *   将向量投影到标签空间。
    *   计算残差向量。
    *   使用残差向量进行下一轮标签搜索。
    *   重复直至 90% 的语义能量被解释。

### 阶段三：扩张与召回 (Expansion & Recall)
1.  **核心标签补全**：若显式指定的核心标签未被搜到，强行从数据库捞取其向量。
2.  **关联词拉回**：根据共现矩阵，从高权重标签扩展出关联语义。
3.  **特权过滤**：核心标签无条件保留，普通标签需通过世界观门控筛选。

### 阶段四：重塑与检索 (Reshaping & Retrieval)
1.  **动态参数计算**：
    *   **Beta (TagWeight)**：根据逻辑深度和共振值动态决定标签增强的比例。
    *   **K 值调整**：根据信息量动态决定检索片段的数量。
2.  **向量融合**：将原始向量与增强标签向量按动态比例混合，实现“语义坍缩”。
3.  **偏振修正 (PSR Correction)**：
    *   检测上下文中的语义偏振信号。
    *   若触发犹豫机制，计算偏振向量投影。
    *   根据偏振强度，计算对冲检索参数。
4.  **最终检索与对冲召回**：
    *   执行主向量检索。
    *   若偏振触发，同步执行“负向对冲”检索，将对立观点或反向案例引入召回上下文。

## 5. 工程原理亮点

### 5.1 核心标签 vs. 普通标签
| 特性 | 核心标签 (Core Tags) | 普通标签 (Other Tags) |
| :--- | :--- | :--- |
| **产生方式** | 显式指定或首轮强感应 | 残差金字塔逐层剥离 |
| **缺失处理** | **虚拟补全**（强行捞取） | 自动忽略 |
| **权重待遇** | **Core Boost** (1.2x-1.4x) | 原始贡献权重 |
| **噪音过滤** | **完全豁免** | 严格门控筛选 |

### 5.2 动态 Beta 公式
[`RAGDiaryPlugin.js`](Plugin/RAGDiaryPlugin/RAGDiaryPlugin.js) 中算法通过以下公式实现能量平衡：
`β = σ(L · log(1 + R) - S · noise_penalty)`
该公式确保了：当用户意图明确（L高）且逻辑清晰（R高）时，算法会加大标签增强力度；当噪音较多（S高）时，则收紧增强，回归稳健检索。

### 5.3 噪音净化器 (Sanitizer)
为了防止 AI 的技术标记干扰向量搜索，算法实现了专门的工具调用净化逻辑，确保向量化的是纯粹的“人类语义”，而非“机器指令”。

### 5.4 辩证认知器 (Dialectical Cognitizer)
V4 版本引入的 PSR 机制本质上是一个可量化、可控制的辩证认知器。它不再盲目追求语义的绝对一致性，而是通过捕捉人类思维中的“犹豫”与“摇摆”，主动提供对冲信息，从而打破 AI 的“回声壁垒”，实现更深层次的逻辑闭环。

## 6. 结论
TagMemo 浪潮算法通过对语义能量的物理级模拟，解决了传统 RAG 在处理复杂意图时容易“跑题”或“漏掉细节”的问题。它不仅是一套检索技术，更是一套对人类语言逻辑进行深度建模的工程实践。尤其是在 V4 中通过“偏振语义舵”实现了从线性检索到辩证召回的跨越。它不仅能精准捕捉用户的显性意图，更能通过物理动态化语义投影，洞察并回应用户思维中的隐性摇摆，为 RAG 系统注入了真正的辩证思考能力。