# PyScreenshot 插件使用指南

> **⚠️ 隐私安全警告**
> 
> 请注意：本插件的“AI内容分析”功能会**将您屏幕截取的完整图像发送给第三方AI服务提供商**（例如 OpenAI, Google 等，取决于您的配置）。
> 
> 请确保您了解并接受相应服务商的隐私政策。**切勿在包含个人隐私、敏感信息或机密内容的屏幕上使用本插件。**
> 
> **为了最大程度地保护您的隐私，您可以将 `PROCESSING_MODE` 设置为 `"capture_only"`，以完全禁用任何数据上传。**
> **最初分享版 `PROCESSING_MODE` 设置为 `"capture_only"`，任何修改与开发者无关。**

欢迎使用 `PyScreenshot` 插件！这是一个功能强大的 VCP 同步插件，它不仅可以截取您电脑的屏幕，还能借助 AI 视觉模型分析截图内容，并选择性地将截图保存到本地。

## ✨ 主要功能

- **实时屏幕截图**: 即时截取您整个桌面的图像。
- **AI 内容分析**: 调用多模态视觉大模型，自动生成对截图的详细文字描述。
- **灵活的本地存储**: 您可以自由选择是否将截图保存到本地，并能指定任意存储路径。
- **生成公开URL**: 成功保存图片后，会自动生成一个公开的URL链接，便于分享和在AI回复中直接显示，避免了传输大量Base64数据。
- **无缝集成**: 作为 VCP 插件，可以被 AI 代理在对话中无缝调用。

---

## ⚙️ 配置步骤

在使用本插件前，请务必完成以下配置。

### 步骤 1: 安装依赖库

本插件需要两个 Python 库才能正常工作：`Pillow` 用于屏幕截图，`requests` 用于网络请求。请在您的 Python 环境中执行以下命令进行安装：

```bash
pip install Pillow requests
```

### 步骤 2: 配置处理模式

本插件支持三种灵活的工作模式，您可以通过 `config.env` 文件中的 `PROCESSING_MODE` 设置进行精确控制。

- **文件路径**: `Plugin/PyScreenshot/config.env`
- **配置项**: `PROCESSING_MODE`

您可以选择以下三种模式之一：

1.  **`full_analysis` (完整分析模式 - 默认)**
    - **行为**: 插件会截图，先将其发送给一个独立的视觉AI模型进行内容分析，然后将“分析描述”和“图片本身”一起打包，发送给最终的对话AI。
    - **用途**: 功能最完整，可以得到两层AI的加工润色。

2.  **`direct_to_ai` (直接发送模式)**
    - **行为**: 插件会截图，但**跳过**独立的视觉模型分析步骤，直接将“图片本身”发送给对话AI。
    - **用途**: 当您希望对话AI直接对原始图片进行响应，而不需要预先生成的描述时使用。

3.  **`capture_only` (仅截图/隐私模式)**
    - **行为**: 插件**只会进行截图和本地保存**（如果配置了`SAVE_PATH`），**完全不会将图片发送给任何AI**。插件将只返回一条简单的成功消息。
    - **用途**: 当您只需要截图功能，或对隐私保护有最高要求时使用。

### 步骤 3: (可选) 配置图像分析 API

**仅在 `PROCESSING_MODE` 设置为 `full_analysis` 时需要此配置。**

本插件的图像分析功能依赖于一个外部的 AI 视觉模型。它会复用您系统中为 `ImageProcessor` 插件设置的全局环境变量。

请确保以下环境变量已在您的 VCP 服务环境中正确设置：

- `API_URL`: 多模态模型的 API 地址 (例如: `https://api.openai.com`)。
- `API_Key`: 您的 API 密钥。
- `MultiModalModel`: 您希望使用的模型名称 (例如: `gpt-4-vision-preview`)。
- `MultiModalPrompt`: 您希望在分析图片时，向模型发出的指令 (例如: `请详细描述这张图片的内容。`)。

如果这些变量未设置，插件虽然能截图，但会返回图像分析失败的错误信息。

### 步骤 4: (可选) 配置截图存储路径

如果您希望将截取的图片自动保存到本地磁盘，请配置本插件目录下的 `config.env` 文件。

- **文件路径**: `Plugin/PyScreenshot/config.env`
- **配置项**: `SAVE_PATH`

**【重要】** 路径的起点是**本插件所在的目录** (`Plugin/PyScreenshot/`)，而不是项目的根目录。

您可以按需修改 `SAVE_PATH` 的值：

- **保存到项目根目录下的 `image/PyScreenshot` 文件夹 (推荐的相对路径)**:
  ```env
  # 使用 ../../ 返回上两级目录，回到项目根目录
  SAVE_PATH=../../image/PyScreenshot/
  ```

- **保存到绝对路径**:
  ```env
  # 直接指定磁盘上的完整路径
  SAVE_PATH=D:/MyScreenshots/
  ```

- **不保存截图**:
  ```env
  # 将此行留空或注释掉
  SAVE_PATH=
  ```

---

## 🚀 如何使用

配置完成后，**请务必重启您的 VCP 主服务** 以加载所有新配置和代码。

之后，您就可以通过 AI 代理发起工具调用了。

**调用示例:**

```
<<<[TOOL_REQUEST]>>>
tool_name:「始」PyScreenshot「末」
<<<[END_TOOL_REQUEST]>>>
```

**成功返回示例:**

调用成功后，您会收到类似下面的图文并茂的回复：

> 已成功截取屏幕图像并进行了分析。
>
> **图像描述:**
> 这是一张电脑屏幕的截图。屏幕上显示着一个代码编辑器，背景是深色的，代码使用了多种颜色高亮。右侧似乎是一个文件浏览器。
>
> **文件已保存至:**
> `../../image/PyScreenshot/screenshot_20251018_151500.jpg`
>
> **公开访问URL:**
> http://127.0.0.1:8111/pw=your_key/images/PyScreenshot/screenshot_20251018_151500.jpg
>
> [此处会显示截取的图片]

---

## ⚠️ 常见问题排查 (Troubleshooting)

- **错误: `execution timed out` (执行超时)**
  - **原因**: 插件执行（特别是AI分析部分）超过了预设时间。
  - **解决方案**: 我们已将默认超时延长至90秒，通常已足够。如果仍超时，请检查您的网络连接或 API 服务是否响应缓慢。

- **错误: `No such file or directory`**
  - **原因**: VCP 服务没有加载到最新的插件配置。
  - **解决方案**: **重启 VCP 主服务**。这是解决插件路径问题的最有效方法。

- **错误: `[Image Analysis Failed: ...]`**
  - **原因**: 图像分析所需的 API 配置不正确或不完整。
  - **解决方案**: 返回**步骤 3**，仔细检查 `API_URL`, `API_Key` 等环境变量是否已正确设置。
