# CapturePreprocessor 插件使用指南

> **⚠️ 隐私安全警告**
> 
> 请注意：本插件的“AI内容分析”功能会**将您屏幕截取的完整图像发送给第三方AI服务提供商**（例如 OpenAI, Google 等，取决于您的配置）。
> 
> 请确保您了解并接受相应服务商的隐私政策。**切勿在包含个人隐私、敏感信息或机密内容的屏幕上使用本插件。**
> 
> **为了最大程度地保护您的隐私，您可以将 `PLACEHOLDER_MODE` 设置为 `"capture_only"`，以完全禁用任何数据上传。**
> **最初分享版 `PLACEHOLDER_MODE` 设置为 `"capture_only"`，任何修改与开发者无关。**
---

## ✨ 核心功能

欢迎使用 `CapturePreprocessor`！这是一个强大的 **预处理插件**，它能将您在系统提示词中设置的简单占位符，动态地转换成实时的屏幕截图或摄像头画面，并将其无缝注入到您的对话中，极大地增强了AI的视觉感知能力。

您无需再手动调用工具，只需在系统提示词中“声明”您想要看的内容，剩下的交给本插件自动完成！

## 🚀 主要特性

- **声明式调用**：使用简洁的 `{{VCPScreenShot}}` 和 `{{VCPCameraCapture}}` 占位符，即可在对话前动态捕获图像。
- **无缝集成**：自动将捕获的图像和初步分析文本注入到用户消息中，让AI能够自然地理解和响应图文内容。
- **独立配置**：拥有自己独立的 `config.env` 文件，可以分别控制截图和拍照的行为模式，而完全不影响原有 `PyScreenshot` 和 `PyCameraCapture` 插件的默认设置。
- **即时响应**：在您发送消息的瞬间触发，确保AI获取到的是最新的视觉信息。

## 工作原理（简化版）

1.  **设置占位符**：您在VCP的系统提示词中写入 `{{VCPScreenShot}}` 或 `{{VCPCameraCapture}}`。
2.  **发送消息**：您正常地向AI发送一条消息。
3.  **自动处理**：在您的消息发送给AI之前，本插件会自动执行：
    - 检测到系统提示词中的占位符。
    - 调用对应的Python插件（`PyScreenshot` 或 `PyCameraCapture`）执行截图或拍照。
    - 将系统提示词中的占位符删除，以保持其干净。
    - 将Python插件返回的 **图文结果**（图片 + 描述文本）注入到您刚刚发送的 **用户消息** 中。
4.  **AI接收**：最终，AI会收到一条包含您原始文本和刚刚捕获的图像的多模态消息，并对此进行响应。

---

## ⚙️ 如何使用

### 步骤1：在系统提示词中放置占位符

请在您的AI Agent的系统提示词（System Prompt）中的任意位置，根据需要添加以下占位符：

-   **截取全屏**：
    ```
    {{VCPScreenShot}}
    ```

-   **捕获摄像头画面**：
    ```
    {{VCPCameraCapture}}
    ```
    或者，如果您有多个摄像头，可以指定其索引（0是第一个，1是第二个，以此类推）：
    ```
    {{VCPCameraCapture(1)}}
    ```
开发者留言：多半无法索引，未知未修复bug。
**系统提示词示例：**

```
你是一个名为Nova的视觉助手。请根据我提供的屏幕截图和摄像头画面，对我的问题进行详细解答。

这是我当前的屏幕截图：
{{VCPScreenShot}}

这是我面前的摄像头画面：
{{VCPCameraCapture}}
```

### 步骤2：正常对话

设置好系统提示词后，您只需像往常一样与AI对话即可。每次您发送消息，本插件都会自动执行并注入最新的图像。

---

## 🔧 独立配置

本插件拥有自己独立的配置文件，位于 `Plugin/CapturePreprocessor/config.env`。您可以在此文件中精确控制占位符的行为，而**不会**影响 `PyScreenshot` 或 `PyCameraCapture` 插件被其他方式（如手动工具调用）使用时的设置。

**配置文件内容说明：**

```env
# 此配置文件专门用于控制占位符 {{VCPScreenShot}} 和 {{VCPCameraCapture}} 的行为。
# 它不会影响通过标准工具调用 (Tool Call) 时的插件行为。

# 可选值:
# full_analysis: (默认) 预先通过多模态模型分析图片，然后将图片和分析结果一起发送给AI。
# direct_to_ai:  直接将原始图片发送给AI，让AI自行分析。
# capture_only:  仅捕获图片并保存（如果设置了路径），不发送给任何AI，以保护隐私。

# 控制 {{VCPScreenShot}} 占位符的行为
PLACEHOLDER_SCREENSHOT_MODE="full_analysis"

# 控制 {{VCPCameraCapture}} 占位符的行为
PLACEHOLDER_CAMERA_MODE="full_analysis"
```

- **`PLACEHOLDER_SCREENSHOT_MODE`**: 决定 `{{VCPScreenShot}}` 的工作模式。
- **`PLACEHOLDER_CAMERA_MODE`**: 决定 `{{VCPCameraCapture}}` 的工作模式。

修改这些值后，**请务必重启VCP服务**以使配置生效。

---

## ⚠️ 常见问题

-   **问：为什么我设置了占位符却没有反应？**
    -   **答：** 请检查以下几点：1) 是否已重启VCP服务？ 2) 占位符是否确实放置在 **系统提示词** 中？ 3) 占位符的拼写是否完全正确（`{{VCPScreenShot}}` 和 `{{VCPCameraCapture}}`）？ 4) `preprocessor_order.json` 文件中是否包含了 `CapturePreprocessor`？

-   **问：AI提示“初步分析失败”，但还是看到了图片，这是为什么？**
    -   **答：** 这是正常现象。当您将模式设置为 `full_analysis`，但VCP的外部多模态模型API Key未配置或配置错误时，Python脚本会返回一个“初步分析失败”的引导性文本，但依然会附上原始图片。最终的AI模型接收到这个图文混排的消息后，仍可以对原始图片进行分析。

-   **问：我可以在用户的聊天消息里使用占位符吗？**
    -   **答：** 不可以。当前的设计是，本插件只扫描 **系统提示词** 中的占位符。
