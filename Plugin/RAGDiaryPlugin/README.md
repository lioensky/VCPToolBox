## VCP 4.5 AI日记全功能详解

## 创建和管理日记知识库

### 1. AI会主动调用`DailyNoteWrite`异步插件创建日记，如果创建成功，你将会在前端看到具体的日记气泡，VCP通知栏也会有具体的文件信息创建推送。该插件允许Agent为日记内容提供分类tag，从而构建不同类型日记本的归档入库。

所有日记以.txt/.MD格式保存在各自agent的主记忆区和知识分区，方便前端渲染和管理。后端服务器构建对等的对应维度向量化数据库。向量化数据库根据日记文件夹的哈希值变动精细化差分进行即时的向量化更新匹配，以保证数据库的双向一致性。日记文件构建强壮的多边同步机制。并且和rag数据库基于哈希值，时间戳和base64字段的原子级向量同步，用户改一个字，向量化就处理一那一句话。多重区块化RAG管理和备份，自动抗崩溃，内置数据库损毁自修复镜像，内置回溯数据库版本功能。

### 2. AI会主动调用`DailyNoteEdit`同步/异步插件来更新或者编辑单条已有日记，构建流畅的上下文记忆更新体验。

### 3. `DailyNoteManager`插件，这是一个强大的日记批处理插件，不推荐Agent自己操作该插件。建议使用VCP服务器内置的记忆大师Agent来操作该插件。该插件会对Agent指定时间段内的日记进行批量操作，以进行事件合并，结构优化，语法去冗等复杂功能。

### 4. `DeepMemo`插件，允许Agent在过往聊天历史上下文中进行块级搜索，Agent可以自定义块级域的窗口大小和搜索深度。

## 四种日记调用模式详解

根据您的具体需求，可以选择最合适的模式来调用日记内容：

### 1. `{{角色日记本}}` (服务器原生)

-   **工作模式**：**无条件全文注入**。
-   **描述**：这是服务器内置的、最基础的日记调用方式。一旦在System Prompt中检测到此语法，它会**无条件地**将指定角色的**所有**日记内容完整地注入到上下文中。
-   **适用场景**：当您需要角色完整回顾其所有记忆，或者需要对整个日记进行全面总结时。
-   **注意**：此模式不受本插件的任何智能检索逻辑控制。

### 2. `[[角色日记本]]` (插件)

-   **工作模式**：**无条件 RAG 片段检索**。
-   **描述**：此模式会忽略相似度判断，直接根据当前对话的上下文（根据话题复杂度的动态上下文与根据话题宽泛度的动态K值），从指定的日记向量数据库中检索出最相关的**记忆片段**。
-   **支持主动动态K值**：是。您可以使用 `[[角色日记本:1.5]]` 的语法来调整检索片段的数量（`1.5` 是一个乘数，会乘以插件动态计算出的基础K值）。
-   **适用场景**：当您明确知道需要根据当前话题从日记中寻找相关信息，但又不希望注入全部内容时。
-   **高级用法**：此模式支持强大的 **时间感知检索** 和 **语义组增强检索**，详见“高级功能与配置”部分。

### 3. `<<角色日记本>>` (插件)

-   **工作模式**：**基于相似度阈值的全文注入**。
-   **描述**：这是一种智能的全文注入模式。插件会首先计算当前对话上下文与该“日记本”主题（基于其名称和预设标签）的向量相似度。**只有当相似度超过预设的阈值时**，才会将该角色的**全部**日记内容注入。
-   **适用场景**：适用于那些不确定当前对话是否与某个角色的日记高度相关，希望由AI自动判断是否需要加载其完整背景故事的场合。例如<<小克工作ID日记本>>，<<VCP开发进度日记本>>，这种仅在需要的场景才会全程追踪的日记本。可以有效避免无关日记内容对上下文的污染。

### 4. `《《角色日记本》》` (插件) - **混合模式**

-   **工作模式**：**基于相似度阈值的 RAG 片段检索**。
-   **描述**：这是最智能、最灵活的模式，它结合了 `<<>>` 和 `[[]]` 的优点。它会先像 `<<>>` 模式一样进行相似度评估，**只有当相似度达标后**，才会像 `[[]]` 模式一样，去检索相关的**记忆片段**而非注入全文。
-   **支持动态K值**：是。同样支持 `《《角色日记本:1.5》》` 语法。
-   **适用场景**：大型日记库最推荐的日常使用模式。它既能通过阈值判断避免无关信息的干扰，又能在相关时只提取最关键的记忆片段，最大限度地保证了上下文的精确性和高效性。

---

## 高级功能与配置

### 动态K值

RAG检索的K值由用户发言的难度与AI话题的广度共同决定，并构建一个动态的上下文向量化窗口大小来作为匹配知识库的基础值。

对于 `[[]]` 和 `《《》》` 模式，您可以通过在末尾添加 `:乘数` 的方式来动态调整检索结果的数量。例如，`:1.5` 会将默认检索数量乘以1.5，而 `:0.5` 则会减半。这为您提供了更精细的控制。

### 标签 (Tags) 与阈值 (Threshold)

`<<>>` 和 `《《》》` 模式的相似度判断能力可以通过在 `rag_tags.json` 文件中设置标签和独立阈值来增强。

-   **Tags**: 您可以为每个日记本定义一组核心标签和权重（如 `"tags": ["战斗:1.2", "情感", "家庭:0.8"]`），插件会根据这些标签生成一个“增强向量”，使其能更准确地理解日记本的核心主题。
-   **Threshold**: 您可以为每个日记本设置一个独立的相似度阈值，覆盖全局默认值，以实现更精细的控制。

### 时间感知检索 (Time-Aware RAG) - 解决“我们上周聊了啥？”的利器

这是RAG日记插件最核心的创新之一，旨在解决RAG应用中最棘手的难题：**基于模糊时间概念的记忆回溯**。

-   **启用语法**：在 `[[]]` 模式后添加 `::Time` 标记 -> `[[角色日记本::Time]]`
-   **工作模式**：
    1.  当检测到 `::Time` 标记时，插件会激活**时间跨度拟合算法**。
    2.  它会智能解析用户最新发言中的所有自然语言时间描述（如“最近”、“上周五”、“三个月前”）。
    3.  **支持多时间点查询**：如果一句话中包含多个时间点（如“我和小克上周以及三个月前都聊了什么？”），插件会分别解析并合并所有时间范围的结果。
    4.  **智能去重**：算法会自动对解析出的时间范围和最终检索到的日记内容进行去重，确保结果的简洁性和唯一性。
    5.  **混合检索**：最终结果会智能融合“语义相关（RAG）”和“时间范围”两个维度的信息，提供最全面的上下文回溯。
-   **适用场景**：任何需要根据时间线索来回忆过去的对话场景。例如：
    -   “我们上周是不是讨论过VCP的更新计划？”
    -   “让我想想三个月前我在做什么。”
    -   “回顾一下我最近一周的工作进展。”

### 语义组增强检索 (Semantic Group RAG) - 让检索更懂你的“梗”

这是另一项核心创新，它允许你将零散的关键词组织成具有特定语义的“词组”，从而极大地提升检索的**可控性**和**准确性**。

-   **启用语法**：在 `[[]]` 模式后添加 `::Group` 标记 -> `[[角色日记本::Group]]`
-   **工作模式**：
    1.  当检测到 `::Group` 标记时，插件会激活**语义组管理器**。
    2.  它会分析用户发言，看是否命中了您在“语义组编辑器”中预设的任何词组的关键词。
    3.  如果命中，它会将原始查询向量与被激活的词组的“组向量”进行**加权融合**，生成一个全新的、语义更精确的“增强查询向量”。
    4.  最后，使用这个增强向量去数据库中进行检索。
-   **组合使用**：此功能可以和动态K值无缝结合，例如 `[[角色日记本:1.5::Group]]`。
-   **适用场景**：
    -   **精确控制主题**：当你希望检索聚焦于某个特定领域（如“编程”、“克苏鲁神话”）时，即使你的问题本身很宽泛，也能确保检索结果高度相关。
    -   **弥补向量短板**：当某些概念（如“愚者”、“世界”）在向量空间中距离较远，但逻辑上属于同一主题时，语义组可以强行将它们关联起来。
    -   **玩梗/黑话检索**：你可以为特定角色的“黑话”或“梗”创建一个语义组，让AI能听懂你们之间的特定语境。

---

## 强烈建议：使用服务器管理面板

手动编辑 `rag_tags.json` 文件可能比较复杂且容易出错。

我们强烈建议您使用服务器自带的管理面板来管理所有与日记相关的数据和配置。在管理面板中，您可以方便地：

-   **查看和编辑每个角色的日记内容**。
-   **为日记本添加、删除和调整带权重的标签 (Tags)**。
-   **为每个日记本独立设置相似度阈值 (Threshold)**。
-   **创建和编辑语义组 (Semantic Groups)**，为你的知识库添加更深层次的逻辑关联。
-   **监控所有日记知识库的向量化流程并进行调控**。

请访问您的服务器主页，通常可以在设置或插件管理区域找到相关入口。这将为您提供一个直观、高效的图形化界面来充分利用本插件的全部功能。