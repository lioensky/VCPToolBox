VCPTavern 是一个强大的消息预处理插件，专为 VCP 系统设计。它允许用户通过预设规则，动态地向 AI 对话中注入系统提示、时间感知信息和其他上下文数据，从而增强 AI 的角色扮演能力和环境感知能力。

## ✨ 核心功能

1.  **动态消息注入**：
    *   支持在对话的不同位置（System Prompt 前/后、最后一条用户消息前/后、所有用户消息前/后）注入自定义内容。
    *   支持深度注入（Depth Injection），将内容插入到聊天记录的特定深度。

2.  **智能时间感知 (Smart Time Perception)**：
    *   **时间固化**：配合 `Last User Message` 注入位置，只有最新消息会带上当前时间，历史消息保持“过去”状态，完美解决时间线收束问题。
    *   **会话记忆**：自动记录上次对话时间，让 AI 知道“距离上次见面过去了多久”。
    *   **双锚点身份识别**：即使所有角色共用同一个预设，插件也能通过“角色名”和“话题哈希”自动区分不同角色和话题，互不干扰。

3.  **灵活的触发机制**：
    *   通过在 System Prompt 或 World Info 中添加简单的触发词（如 `{{VCPTavern::dailychat}}`）即可激活特定预设。
    *   支持显式 ID 指定（如 `{{VCPTavern::dailychat::MyTopic}}`）以强制绑定特定会话。

## 🚀 快速开始

### 1. 配置预设 (Preset)

在 VCP 控制面板的 VCPTavern 插件页面（或直接编辑 `presets/` 目录下的 JSON 文件）创建一个预设。

**推荐配置 (实现完美时间感)：**

*   **预设名称**：`dailychat` (示例)
*   **注入规则**：
    *   **类型**：相对注入 (Relative)
    *   **目标**：最后的用户消息 (Last User Message)
    *   **位置**：之后 (After)
    *   **内容**：
        ```text
        [系统提示:]
        当前时间：{{Date}} {{Time}}
        距离上次见面已过去：{{TimeSinceLastChat}}
        （上次见面时间：{{LastChatTime}}）
        ```

### 2. 激活预设

在你的 AI 角色卡 (Character Card) 的 **System Prompt** 或 **World Info** 的最前方，添加触发词：

```text
{{VCPTavern::dailychat}}
```

### 3. 享受对话！

现在，你的 AI 将拥有真实的时间观念：
*   **首次对话**：AI 会知道这是第一次见面。
*   **重逢**：AI 会感叹“好久不见，都过去 3 天了”。
*   **连续对话**：AI 会知道这是刚刚才说过的话。

---

## 🛠️ 进阶用法

### 变量列表

你可以在注入内容中使用以下变量，它们会在发送给 AI 时被自动替换：

| 变量名 | 描述 | 示例 |
| :--- | :--- | :--- |
| `{{Date}}` | 当前日期 | `2026/2/14` |
| `{{Time}}` | 当前时间 | `16:30:00` |
| `{{Today}}` | 当前星期 | `星期六` |
| `{{TimeSinceLastChat}}` | 距离上次对话的时间间隔 | `3天5小时` 或 `刚刚` |
| `{{LastChatTime}}` | 上次对话的具体时间点 | `2026/2/11 10:00:00` |

### 身份识别机制 (Identity Recognition)

VCPTavern 如何区分不同的角色和话题？

1.  **显式 ID (最高优先级)**：
    *   用法：`{{VCPTavern::预设名::自定义ID}}`
    *   示例：`{{VCPTavern::dailychat::Keqing_Main}}`
    *   作用：强制指定当前会话的 ID，不同 ID 之间时间互不干扰。

2.  **自动识别 (双锚点机制)**：
    *   **角色锚点**：自动从 System Prompt 中提取 `Name: xxx` 或 `Char: xxx` 字段。如果找不到，则计算 System Prompt 后半部分的哈希值（抗 RAG 干扰）。
    *   **话题锚点**：自动计算“第一条用户消息”的哈希值。
    *   **效果**：
        *   切换角色 -> 自动识别为新会话。
        *   同一角色开启新话题（第一句话变了） -> 自动识别为新会话。
        *   同一话题内继续聊天 -> 自动延续时间记忆。

## 📂 目录结构

*   `VCPTavern.js`: 插件核心逻辑。
*   `presets/`: 存储预设配置文件的目录。
*   `access_logs.json`: 自动生成的会话时间记录文件（请勿手动修改）。
*   `plugin-manifest.json`: 插件元数据。

## ⚠️ 注意事项

*   **注入位置**：为了获得最佳的时间感知体验，强烈建议将时间信息注入到 **`Last User Message`** 之后。如果注入到 `All User Messages`，会导致历史消息的时间也被刷新为当前时间（虽然这在某些特殊场景下可能是有意为之）。
*   **VChat 兼容性**：本插件完美兼容 VChat 及 SillyTavern 等前端，无需特殊配置即可自动识别角色。

---
*Powered by Nova for 辉宝主人❤*
