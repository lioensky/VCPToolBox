# VCPToolBox ç³»ç»Ÿæ¶æ„æ–‡æ¡£

**ç‰ˆæœ¬:** VCP 6.4  
**ç”Ÿæˆæ—¥æœŸ:** 2026-02-13  
**é€‚ç”¨æäº¤:** d09c49f

---

## ç›®å½•

1. [ç³»ç»Ÿæ€»è§ˆ](#1-ç³»ç»Ÿæ€»è§ˆ)
2. [11æ­¥å¯åŠ¨åºåˆ—](#2-11æ­¥å¯åŠ¨åºåˆ—)
3. [æ ¸å¿ƒä¸‰è§’æ¶æ„](#3-æ ¸å¿ƒä¸‰è§’æ¶æ„)
4. [æ¨¡å—ä¾èµ–å›¾](#4-æ¨¡å—ä¾èµ–å›¾)
5. [æ ¸å¿ƒç»„ä»¶è¯¦è§£](#5-æ ¸å¿ƒç»„ä»¶è¯¦è§£)
6. [èŠå¤©è¯·æ±‚å®Œæ•´æµç¨‹](#6-èŠå¤©è¯·æ±‚å®Œæ•´æµç¨‹)
7. [åˆ†å¸ƒå¼å·¥å…·æ‰§è¡Œæµç¨‹](#7-åˆ†å¸ƒå¼å·¥å…·æ‰§è¡Œæµç¨‹)
8. [é”™è¯¯å¤„ç†æœºåˆ¶](#8-é”™è¯¯å¤„ç†æœºåˆ¶)
9. [å…³é”®è®¾è®¡å†³ç­–](#9-å…³é”®è®¾è®¡å†³ç­–)

---

## 1. ç³»ç»Ÿæ€»è§ˆ

VCPToolBox æ˜¯ä¸€ä¸ª Node.js æ ¸å¿ƒçš„ AI ä¸­é—´å±‚ç³»ç»Ÿï¼Œé‡‡ç”¨**æ‰å¹³åŒ–æ ¹ç›®å½•è¿è¡Œç»“æ„**ï¼ˆæ—  `src/` åˆ†å±‚ï¼‰ï¼Œé€šè¿‡æ’ä»¶é©±åŠ¨å®ç° AI èƒ½åŠ›å¢å¼ºã€‚

### 1.1 æ¶æ„å…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å®¢æˆ·ç«¯è¯·æ±‚å±‚                                     â”‚
â”‚         (VCPChat / SillyTavern / è‡ªå®šä¹‰å‰ç«¯ / HTTP API / WebSocket)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          server.js - HTTP/SSE å…¥å£                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Express App â”‚  â”‚ ä¸­é—´ä»¶é“¾    â”‚  â”‚ è·¯ç”±å±‚      â”‚  â”‚ ChatCompletionHandlerâ”‚ â”‚
â”‚  â”‚ :5890       â”‚  â”‚ (é‰´æƒ/CORS) â”‚  â”‚ (/v1/*)     â”‚  â”‚ (å¯¹è¯ä¸»æµç¨‹)         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                           â”‚                           â”‚
          â–¼                           â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Plugin.js       â”‚â—„â”€â”€â”€â”€â”€â–ºâ”‚ WebSocketServer.js  â”‚â—„â”€â”€â”€â”€â”€â–ºâ”‚ KnowledgeBaseManagerâ”‚
â”‚ (æ’ä»¶ç”Ÿå‘½å‘¨æœŸ)   â”‚       â”‚ (åˆ†å¸ƒå¼é€šä¿¡éª¨æ¶)     â”‚       â”‚ (å‘é‡åº“/RAG)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                           â”‚
          â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Plugin/ ç›®å½•    â”‚       â”‚ åˆ†å¸ƒå¼èŠ‚ç‚¹é›†ç¾¤        â”‚
â”‚ 70+ æœ¬åœ°æ’ä»¶    â”‚       â”‚ (VCPDistributedServer)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯ | æ–‡ä»¶ä½ç½® |
|------|------|----------|
| è¿è¡Œæ—¶ | Node.js (CommonJS) | `server.js:1` |
| Web æ¡†æ¶ | Express.js | `server.js:231` |
| å‘é‡ç´¢å¼• | Rust N-API (USearch/Vexus) | `rust-vexus-lite/` |
| æ•°æ®åº“ | SQLite (better-sqlite3) | `KnowledgeBaseManager.js:83` |
| WebSocket | ws | `WebSocketServer.js:46` |
| æ–‡ä»¶ç›‘å¬ | chokidar | `KnowledgeBaseManager.js:901` |
| è¿›ç¨‹ç®¡ç† | pm2-runtime | `Dockerfile` |

### 1.3 ä¸»è¦å­ç³»ç»Ÿ

1. **HTTP/SSE æœåŠ¡å±‚**: è¯·æ±‚é‰´æƒã€æ¨¡å‹è½¬å‘ã€æµå¼é”™è¯¯ä»£ç†ã€ä¸­æ–­æ§åˆ¶  
   ğŸ“ `server.js:465-493`, `server.js:636-745`, `modules/chatCompletionHandler.js:483-511`
2. **æ’ä»¶è¿è¡Œæ—¶**: manifest å‘ç°/åŠ è½½ã€å…­ç±»æ’ä»¶æ‰§è¡Œã€æœåŠ¡è·¯ç”±æ³¨å†Œã€çƒ­é‡è½½æ¸…ç†  
   ğŸ“ `Plugin.js:388-564`, `Plugin.js:632-720`, `Plugin.js:805-1030`
3. **WebSocket é€šä¿¡éª¨æ¶**: å®¢æˆ·ç«¯åˆ†å‹è®¤è¯ã€æ¶ˆæ¯åˆ†å‘ã€åˆ†å¸ƒå¼å·¥å…·è°ƒç”¨é—­ç¯  
   ğŸ“ `WebSocketServer.js:52-57`, `WebSocketServer.js:400-465`, `WebSocketServer.js:467-509`
4. **çŸ¥è¯†åº“ä¸ RAG å­ç³»ç»Ÿ**: SQLite + å…¨å±€ Tag ç´¢å¼• + EPA + æ®‹å·®é‡‘å­—å¡” + å»é‡å™¨  
   ğŸ“ `KnowledgeBaseManager.js:76-135`, `KnowledgeBaseManager.js:446-621`
5. **ç®¡ç†é¢æ¿ä¸è¿ç»´å…¥å£**: `/AdminPanel` é™æ€é¡µé¢ã€`/admin_api` å—æ§æ¥å£  
   ğŸ“ `server.js:316-460`, `WebSocketServer.js:521-534`

---

## 2. 11æ­¥å¯åŠ¨åºåˆ—

ä»¥ä¸‹æ˜¯ `node server.js` æ‰§è¡Œæ—¶çš„å®Œæ•´å¯åŠ¨åºåˆ—ï¼Œæ¯æ­¥æ ‡æ³¨**é˜»å¡ç‚¹**å’Œ**æ–‡ä»¶ä½ç½®**ï¼š

### Step 1: ç¯å¢ƒé…ç½®åŠ è½½ âš ï¸ é˜»å¡
ğŸ“ `server.js:4`
```javascript
dotenv.config({ path: 'config.env' });
```
- **é˜»å¡åŸå› **: åŒæ­¥è¯»å–é…ç½®æ–‡ä»¶ï¼Œå¤±è´¥åˆ™è¿›ç¨‹é€€å‡º
- **ä¾èµ–**: `config.env` å¿…é¡»å­˜åœ¨

### Step 2: æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ– âš ï¸ é˜»å¡
ğŸ“ `server.js:20-22`
```javascript
const logger = require('./modules/logger.js');
logger.initializeServerLogger();
logger.overrideConsole();
```
- **é˜»å¡åŸå› **: åŒæ­¥åˆå§‹åŒ–æ—¥å¿—ç›®å½•å’Œæ–‡ä»¶å¥æŸ„
- **è¾“å‡º**: `DebugLog/archive/YYYY-MM-DD/Debug/`

### Step 3: Agent ç›®å½•è·¯å¾„è§£æ (åŒæ­¥)
ğŸ“ `server.js:27-66`
```javascript
function resolveAgentDir() {
    const configPath = process.env.AGENT_DIR_PATH;
    // ... è·¯å¾„è§„èŒƒåŒ–é€»è¾‘
}
AGENT_DIR = resolveAgentDir();
```
- **éé˜»å¡**: çº¯åŒæ­¥è®¡ç®—

### Step 4: Express åº”ç”¨åˆ›å»º
ğŸ“ `server.js:231`
```javascript
const app = express();
app.set('trust proxy', true);
app.use(cors({ origin: '*' }));
```

### Step 5: ä¸­é—´ä»¶é“¾æŒ‚è½½
ğŸ“ `server.js:236-456`
```javascript
app.use(express.json({ limit: '300mb' }));
app.use(express.urlencoded({ limit: '300mb', extended: true }));
// IP è¿½è¸ªä¸­é—´ä»¶ (241-258)
// IP é»‘åå•ä¸­é—´ä»¶ (292-303)
// Bearer Token è®¤è¯ (466-493)
```

### Step 6: è·¯ç”±å±‚æ³¨å†Œ
ğŸ“ `server.js:306-813`
```javascript
app.use(specialModelRouter);           // ç‰¹æ®Šæ¨¡å‹é€ä¼ 
app.get('/v1/models', ...);            // æ¨¡å‹åˆ—è¡¨
app.post('/v1/chat/completions', ...); // ä¸»èŠå¤©ç«¯ç‚¹
app.post('/v1/interrupt', ...);        // ä¸­æ–­æ§åˆ¶
app.post('/v1/human/tool', ...);       // äººç±»ç›´æ¥è°ƒç”¨å·¥å…·
app.post('/plugin-callback/...', ...); // æ’ä»¶å›è°ƒ
```

### Step 7: ChatCompletionHandler å®ä¾‹åŒ–
ğŸ“ `server.js:749-785`
```javascript
const chatCompletionHandler = new ChatCompletionHandler({
    apiUrl, apiKey, modelRedirectHandler, pluginManager,
    activeRequests, writeDebugLog, webSocketServer,
    DEBUG_MODE, SHOW_VCP_OUTPUT, VCPToolCode, ...
});
```

### Step 8: initialize() æ ¸å¿ƒåˆå§‹åŒ– âš ï¸ é˜»å¡
ğŸ“ `server.js:1076-1087`
```javascript
async function initialize() {
    console.log('å¼€å§‹åˆå§‹åŒ–å‘é‡æ•°æ®åº“...');
    await knowledgeBaseManager.initialize(); // âš ï¸ å…³é”®é˜»å¡ç‚¹
    console.log('å‘é‡æ•°æ®åº“åˆå§‹åŒ–å®Œæˆã€‚');

    pluginManager.setProjectBasePath(__dirname);
    pluginManager.setVectorDBManager(knowledgeBaseManager);
    
    console.log('å¼€å§‹åŠ è½½æ’ä»¶...');
    await pluginManager.loadPlugins();        // âš ï¸ å…³é”®é˜»å¡ç‚¹
    console.log('æ’ä»¶åŠ è½½å®Œæˆã€‚');
}
```

**KnowledgeBaseManager.initialize() å†…éƒ¨æµç¨‹** (`KnowledgeBaseManager.js:76-134`):
1. åˆ›å»º `VectorStore/` ç›®å½•
2. è¿æ¥ SQLite æ•°æ®åº“ (`knowledge_base.sqlite`)
3. åŠ è½½ Rust Vexus å‘é‡ç´¢å¼•
4. é¢„çƒ­æ—¥è®°æœ¬åç§°å‘é‡ç¼“å­˜ (åŒæ­¥é˜»å¡) ğŸ“ `KnowledgeBaseManager.js:107-109`
5. åˆå§‹åŒ– EPA æ¨¡å—
6. åˆå§‹åŒ–æ®‹å·®é‡‘å­—å¡”æ¨¡å—
7. å¯åŠ¨æ–‡ä»¶ç›‘å¬å™¨ (chokidar)

**PluginManager.loadPlugins() å†…éƒ¨æµç¨‹** (`Plugin.js:388-563`):
1. æ¸…ç†ç°æœ‰æ’ä»¶çŠ¶æ€ï¼ˆä¿ç•™åˆ†å¸ƒå¼æ’ä»¶ï¼‰
2. éå† `Plugin/` ç›®å½•å‘ç°æ‰€æœ‰ `plugin-manifest.json`
3. è§£ææ’ä»¶é…ç½®å¹¶æ³¨å…¥ç¯å¢ƒå˜é‡
4. åŠ è½½é¢„å¤„ç†å™¨é¡ºåº (`preprocessor_order.json`)
5. åˆå§‹åŒ–æ‰€æœ‰æ¨¡å—çš„ `initialize()` æ–¹æ³•
6. æ„å»º VCP å·¥å…·æè¿°

### Step 9: é™æ€æ’ä»¶é¢„çƒ­
ğŸ“ `server.js:1090-1093`
```javascript
await pluginManager.initializeStaticPlugins();
```
- **è¡Œä¸º**: ä¸ºæ‰€æœ‰ `static` ç±»å‹æ’ä»¶è®¾ç½®å®šæ—¶åˆ·æ–°ä»»åŠ¡
- **ä½ç½®**: `Plugin.js:221-258`

### Step 10: WebSocket æœåŠ¡å™¨åˆå§‹åŒ–
ğŸ“ `server.js:1095-1098`
```javascript
webSocketServer.initialize(server, {
    debugMode: DEBUG_MODE,
    vcpKey: process.env.VCP_Key
});
```
- **ä½ç½®**: `WebSocketServer.js:35-323`
- **è¡Œä¸º**: ç»‘å®š HTTP Server çš„ `upgrade` äº‹ä»¶ï¼Œå¤„ç† WebSocket æ¡æ‰‹

### Step 11: startServer() ç›‘å¬
ğŸ“ `server.js:1100-1105`
```javascript
function startServer() {
    server.listen(port, () => {
        console.log(`VCPæœåŠ¡å™¨æ­£åœ¨ç«¯å£ ${port} ä¸Šè¿è¡Œ`);
    });
}
startServer();
```

---

## 3. æ ¸å¿ƒä¸‰è§’æ¶æ„

VCPToolBox çš„è¿è¡Œæ—¶æ ¸å¿ƒç”±ä¸‰ä¸ªç›¸äº’ä¾èµ–çš„æ¨¡å—ç»„æˆï¼š

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     server.js       â”‚
                    â”‚  (HTTP å…¥å£ & ç¼–æ’)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                â”‚                â”‚
              â–¼                â–¼                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Plugin.js      â”‚ â”‚WebSocketServer.jsâ”‚ â”‚KnowledgeBase    â”‚
    â”‚  (æ’ä»¶ç®¡ç†å™¨)    â”‚ â”‚ (é€šä¿¡éª¨æ¶)       â”‚ â”‚Manager.js (RAG) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                   â”‚
             â”‚   setWebSocketServer()  â”‚
             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
             â”‚                   â”‚
             â”‚  setPluginManager()     â”‚
             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
             â”‚                   â”‚
```

### 3.1 server.js â†” PluginManager

**ä¾èµ–æ³¨å…¥ç‚¹**: `server.js:73, 81-82`
```javascript
const pluginManager = require('./Plugin.js');
// ...
pluginManager.setProjectBasePath(__dirname);
pluginManager.setVectorDBManager(knowledgeBaseManager);
```

**è°ƒç”¨å…³ç³»**:
| è°ƒç”¨æ–¹ | è¢«è°ƒç”¨æ–¹ | æ–¹æ³• | ä½ç½® |
|--------|----------|------|------|
| server.js | PluginManager | `loadPlugins()` | `server.js:1085` |
| server.js | PluginManager | `executePlugin()` | `server.js:948` |
| server.js | PluginManager | `processToolCall()` | `server.js:859` |
| ChatCompletionHandler | PluginManager | `messagePreprocessors.get()` | `chatCompletionHandler.js:394` |

### 3.2 PluginManager â†” WebSocketServer

**åŒå‘æ³¨å…¥**:
```javascript
// PluginManager æŒæœ‰ WebSocketServer å¼•ç”¨
// Plugin.js:27, 33-36
this.webSocketServer = null;
setWebSocketServer(wss) {
    this.webSocketServer = wss;
}

// WebSocketServer æŒæœ‰ PluginManager å¼•ç”¨
// WebSocketServer.js:6, 395-397
let pluginManager = null;
function setPluginManager(pm) {
    pluginManager = pm;
}
```

**åˆå§‹åŒ–é¡ºåº** (`server.js:1081-1098`):
```javascript
// 1. å…ˆè®¾ç½® PluginManager çš„ WebSocket å¼•ç”¨
pluginManager.setWebSocketServer(webSocketServer);
// 2. å†è®¾ç½® WebSocketServer çš„ PluginManager å¼•ç”¨
webSocketServer.setPluginManager(pluginManager);
```

### 3.3 åˆ†å¸ƒå¼å·¥å…·è°ƒç”¨é“¾

```
AI å“åº”å«å·¥å…·è°ƒç”¨
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PluginManager.processToolCall()                              â”‚
â”‚ ğŸ“ Plugin.js:632-803                                         â”‚
â”‚                                                              â”‚
â”‚ if (plugin.isDistributed) {                                  â”‚
â”‚     resultFromPlugin = await this.webSocketServer            â”‚
â”‚         .executeDistributedTool(plugin.serverId, ...);       â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WebSocketServer.executeDistributedTool()                     â”‚
â”‚ ğŸ“ WebSocketServer.js:467-509                                â”‚
â”‚                                                              â”‚
â”‚ server.ws.send(JSON.stringify({                              â”‚
â”‚     type: 'execute_tool',                                    â”‚
â”‚     data: { requestId, toolName, toolArgs }                  â”‚
â”‚ }));                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ†å¸ƒå¼èŠ‚ç‚¹ (VCPDistributedServer)                             â”‚
â”‚ â”€â”€WebSocketâ”€â”€â–º æ‰§è¡Œæœ¬åœ°æ’ä»¶ â”€â”€WebSocketâ”€â”€â–º è¿”å›ç»“æœ           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. æ¨¡å—ä¾èµ–å›¾

### 4.1 æ ¸å¿ƒæ¨¡å—ä¾èµ–

```text
server.js
  -> ChatCompletionHandler
       -> StreamHandler / NonStreamHandler
       -> ToolExecutor
            -> PluginManager.processToolCall()
                 -> (local stdio | hybrid direct | Chrome direct | distributed)
  -> PluginManager
       <-> WebSocketServer (setter åŒå‘æ³¨å…¥)
       -> message preprocessors / service modules / static placeholders
  -> KnowledgeBaseManager
       -> SQLite + Vexus index + EPA + ResidualPyramid + ResultDeduplicator
  -> FileFetcherServer
       -> WebSocketServer (è·¨èŠ‚ç‚¹æ–‡ä»¶å›è¡¥)
```

ğŸ“ è¯æ®: `server.js:69-77`, `server.js:749-770`, `modules/chatCompletionHandler.js:590-608`

### 4.2 æ¨¡å—èŒè´£çŸ©é˜µ

| æ¨¡å— | èŒè´£ | å¯¼å‡ºç±»å‹ | å…³é”®æ–¹æ³• |
|------|------|----------|----------|
| `server.js` | HTTP å…¥å£ã€å¯åŠ¨ç¼–æ’ | æ—  (ç›´æ¥æ‰§è¡Œ) | `initialize()`, `startServer()` |
| `Plugin.js` | æ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç† | `PluginManager` ç±» | `loadPlugins()`, `processToolCall()`, `executePlugin()` |
| `WebSocketServer.js` | åˆ†å¸ƒå¼é€šä¿¡ã€å®æ—¶æ¨é€ | å‡½æ•°å¯¹è±¡ | `initialize()`, `broadcast()`, `executeDistributedTool()` |
| `KnowledgeBaseManager.js` | å‘é‡ç´¢å¼•ã€RAG æ£€ç´¢ | `KnowledgeBaseManager` ç±» | `initialize()`, `search()`, `applyTagBoost()` |
| `chatCompletionHandler.js` | å¯¹è¯ä¸»æµç¨‹ç¼–æ’ | `ChatCompletionHandler` ç±» | `handle()` |
| `messageProcessor.js` | å˜é‡æ›¿æ¢ç®¡çº¿ | å‡½æ•°å¯¹è±¡ | `replaceAgentVariables()`, `replaceOtherVariables()` |
| `agentManager.js` | Agent åˆ«åä¸æ–‡ä»¶ç®¡ç† | å‡½æ•°å¯¹è±¡ | `isAgent()`, `getAgentPrompt()` |
| `roleDivider.js` | è§’è‰²åˆ†å‰²è½¬æ¢ | å‡½æ•°å¯¹è±¡ | `process()` |

---

## 5. æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 5.1 PluginManager (Plugin.js)

#### 5.1.1 æ’ä»¶ç±»å‹æ”¯æŒ

| ç±»å‹ | æ‰§è¡Œæ–¹å¼ | è¶…æ—¶ | ä½ç½® |
|------|----------|------|------|
| `static` | å®šæ—¶æ‰§è¡Œï¼Œæ›´æ–°å ä½ç¬¦ | 60s (å¯é…ç½®) | `Plugin.js:116-179` |
| `synchronous` | stdio åŒæ­¥æ‰§è¡Œ | 60s | `Plugin.js:805-918` |
| `asynchronous` | stdio åˆå§‹å“åº” + HTTP å›è°ƒ | 30min | `Plugin.js:886-906` |
| `service` | ç›´æ¥ requireï¼Œå¸¸é©»å†…å­˜ | æ—  | `Plugin.js:455-466` |
| `hybridservice` | æœåŠ¡ + å·¥å…·è°ƒç”¨ | æ—  | `Plugin.js:683-693` |
| `messagePreprocessor` | æ¶ˆæ¯é¢„å¤„ç†ç®¡é“ | æ—  | `Plugin.js:324-345` |

#### 5.1.2 é…ç½®åˆå¹¶é€»è¾‘

ğŸ“ `Plugin.js:61-105`
```javascript
_getPluginConfig(pluginManifest) {
    const config = {};
    const globalEnv = process.env;
    const pluginSpecificEnv = pluginManifest.pluginSpecificEnvConfig || {};
    
    // ä¼˜å…ˆçº§: æ’ä»¶ç§æœ‰é…ç½® > å…¨å±€ç¯å¢ƒå˜é‡
    if (pluginSpecificEnv.hasOwnProperty(key)) {
        rawValue = pluginSpecificEnv[key];
    } else if (globalEnv.hasOwnProperty(key)) {
        rawValue = globalEnv[key];
    }
    // ... ç±»å‹è½¬æ¢
}
```

#### 5.1.3 åˆ†å¸ƒå¼æ’ä»¶æ ‡è®°

ğŸ“ `Plugin.js:665-672`
```javascript
if (plugin.isDistributed) {
    resultFromPlugin = await this.webSocketServer
        .executeDistributedTool(plugin.serverId, toolName, pluginSpecificArgs);
}
```

### 5.2 WebSocketServer (WebSocketServer.js)

#### 5.2.1 å®¢æˆ·ç«¯ç±»å‹ä¸è·¯å¾„

| å®¢æˆ·ç«¯ç±»å‹ | WebSocket è·¯å¾„æ­£åˆ™ | ç”¨é€” |
|------------|-------------------|------|
| `VCPLog` | `/VCPlog/VCP_Key=(.+)` | æ—¥å¿—æ¨é€ |
| `VCPInfo` | `/vcpinfo/VCP_Key=(.+)` | ä¿¡æ¯æ¨é€ |
| `DistributedServer` | `/vcp-distributed-server/VCP_Key=(.+)` | åˆ†å¸ƒå¼èŠ‚ç‚¹ |
| `ChromeObserver` | `/vcp-chrome-observer/VCP_Key=(.+)` | æµè§ˆå™¨æ’ä»¶è§‚å¯Ÿè€… |
| `ChromeControl` | `/vcp-chrome-control/VCP_Key=(.+)` | æµè§ˆå™¨æ’ä»¶æ§åˆ¶å™¨ |
| `AdminPanel` | `/vcp-admin-panel/VCP_Key=(.+)` | ç®¡ç†é¢æ¿ |

ğŸ“ `WebSocketServer.js:52-57`

#### 5.2.2 æ¶ˆæ¯ç±»å‹å¤„ç†

ğŸ“ `WebSocketServer.js:400-465`
```javascript
handleDistributedServerMessage(serverId, message) {
    switch (message.type) {
        case 'register_tools':    // æ³¨å†Œåˆ†å¸ƒå¼å·¥å…·
        case 'report_ip':         // ä¸ŠæŠ¥ IP ä¿¡æ¯
        case 'update_static_placeholders': // æ›´æ–°é™æ€å ä½ç¬¦
        case 'tool_result':       // å·¥å…·æ‰§è¡Œç»“æœ
    }
}
```

### 5.3 KnowledgeBaseManager (KnowledgeBaseManager.js)

#### 5.3.1 å¤šç´¢å¼•æ¶æ„

```
VectorStore/
â”œâ”€â”€ knowledge_base.sqlite     # SQLite ä¸»æ•°æ®åº“
â”œâ”€â”€ index_global_tags.usearch # å…¨å±€ Tag ç´¢å¼•
â”œâ”€â”€ index_diary_{hash}.usearch # å„æ—¥è®°æœ¬ç‹¬ç«‹ç´¢å¼•
â””â”€â”€ ...
```

ğŸ“ `KnowledgeBaseManager.js:210-242`

#### 5.3.2 TagMemo V3.7 å¢å¼ºç®—æ³•

ğŸ“ `KnowledgeBaseManager.js:443-731`

æ ¸å¿ƒæ­¥éª¤:
1. **EPA åˆ†æ**: é€»è¾‘æ·±åº¦ä¸å…±æŒ¯æ£€æµ‹
2. **æ®‹å·®é‡‘å­—å¡”**: æ–°é¢–åº¦ä¸è¦†ç›–ç‡åˆ†æ
3. **åŠ¨æ€å¢å¼º**: åŸºäº EPA ç»“æœè°ƒæ•´ boost å› å­
4. **ä¸–ç•Œè§‚é—¨æ§**: è¿‡æ»¤è·¨åŸŸå™ªéŸ³
5. **è¯­è¨€è¡¥å¿**: æŠ€æœ¯è¯æ±‡æƒ©ç½š
6. **æ ¸å¿ƒ Tag è¡¥å…¨**: ç¡®ä¿å…³é”®é”šç‚¹ä¸ä¸¢å¤±
7. **è¯­ä¹‰å»é‡**: æ¶ˆé™¤å†—ä½™æ ‡ç­¾

```javascript
// æ ¸å¿ƒå…¬å¼ (KnowledgeBaseManager.js:468-473)
const dynamicBoostFactor = (logicDepth * (1 + resonanceBoost) 
    / (1 + entropyPenalty * 0.5)) * activationMultiplier;
const effectiveTagBoost = baseTagBoost * Math.max(boostRange[0], 
    Math.min(boostRange[1], dynamicBoostFactor));
```

---

## 6. èŠå¤©è¯·æ±‚å®Œæ•´æµç¨‹

### 6.1 æµç¨‹å›¾

```
POST /v1/chat/completions
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è¯·æ±‚é¢„å¤„ç†                                                â”‚
â”‚    â€¢ ç”Ÿæˆ requestId, åˆ›å»º AbortController                   â”‚
â”‚    â€¢ æ³¨å†Œåˆ° activeRequests Map                              â”‚
â”‚    ğŸ“ chatCompletionHandler.js:289-300                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ä¸Šä¸‹æ–‡æ§åˆ¶ (å¯é€‰)                                         â”‚
â”‚    â€¢ æ£€æµ‹ contextTokenLimit å‚æ•°                            â”‚
â”‚    â€¢ è°ƒç”¨ contextManager.pruneMessages()                    â”‚
â”‚    ğŸ“ chatCompletionHandler.js:307-325                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ¨¡å‹é‡å®šå‘                                                â”‚
â”‚    â€¢ modelRedirectHandler.redirectModelForBackend()         â”‚
â”‚    ğŸ“ chatCompletionHandler.js:328-346                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. è§’è‰²åˆ†å‰²å¤„ç† (å¯é€‰)                                       â”‚
â”‚    â€¢ roleDivider.process()                                  â”‚
â”‚    ğŸ“ chatCompletionHandler.js:353-364                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. VCPTavern ä¼˜å…ˆé¢„å¤„ç†                                      â”‚
â”‚    â€¢ pluginManager.executeMessagePreprocessor('VCPTavern')  â”‚
â”‚    ğŸ“ chatCompletionHandler.js:392-401                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. ç»Ÿä¸€å˜é‡æ›¿æ¢ç®¡çº¿                                          â”‚
â”‚    â€¢ messageProcessor.replaceAgentVariables()               â”‚
â”‚    â€¢ é€’å½’å±•å¼€ Agentã€Tar*ã€Var* å ä½ç¬¦                       â”‚
â”‚    ğŸ“ chatCompletionHandler.js:414-444                      â”‚
â”‚    ğŸ“ messageProcessor.js:14-52                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. åª’ä½“å¤„ç†å™¨                                                â”‚
â”‚    â€¢ MultiModalProcessor æˆ– ImageProcessor                  â”‚
â”‚    ğŸ“ chatCompletionHandler.js:448-460                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. å…¶ä»–æ¶ˆæ¯é¢„å¤„ç†å™¨é“¾                                        â”‚
â”‚    â€¢ æŒ‰é¡ºåºæ‰§è¡Œæ‰€æœ‰å·²æ³¨å†Œçš„é¢„å¤„ç†å™¨                          â”‚
â”‚    ğŸ“ chatCompletionHandler.js:463-473                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. è°ƒç”¨ä¸Šæ¸¸ AI API                                           â”‚
â”‚    â€¢ fetchWithRetry() å¸¦é‡è¯•æœºåˆ¶                            â”‚
â”‚    ğŸ“ chatCompletionHandler.js:483-511                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. å“åº”å¤„ç†                                                 â”‚
â”‚     â€¢ StreamHandler æˆ– NonStreamHandler                     â”‚
â”‚     â€¢ æ£€æµ‹å·¥å…·è°ƒç”¨ã€æ‰§è¡Œå·¥å…·ã€é€’å½’è°ƒç”¨                        â”‚
â”‚    ğŸ“ chatCompletionHandler.js:604-607                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 å˜é‡æ›¿æ¢ç®¡çº¿è¯¦è§£

ğŸ“ `messageProcessor.js`

```javascript
// ä¸»å…¥å£å‡½æ•°
async function resolveAllVariables(text, model, role, context, processingStack) {
    // 1. é€’å½’å±•å¼€ Agent å˜é‡ (æ£€æµ‹å¾ªç¯ä¾èµ–)
    // 2. è°ƒç”¨ replacePriorityVariables (è¡¨æƒ…åŒ…ã€æ—¥è®°æœ¬)
    // 3. è°ƒç”¨ replaceOtherVariables (Tar*, Var*, æ—¶é—´, é™æ€æ’ä»¶å ä½ç¬¦)
}
```

**å˜é‡ä¼˜å…ˆçº§** (ä»é«˜åˆ°ä½):
1. `{{agent:Alias}}` / `{{Alias}}` - Agent åˆ«åå±•å¼€
2. `{{Tar*}}` - æœ€é«˜ä¼˜å…ˆçº§æ¨¡æ¿å˜é‡
3. `{{Var*}}` - é€šç”¨è‡ªå®šä¹‰å˜é‡
4. `{{SarPrompt*}}` - æ¨¡å‹æ¡ä»¶æ³¨å…¥
5. `{{Date}}` / `{{Time}}` / `{{Festival}}` - æ—¶é—´å˜é‡
6. `{{VCPPluginName}}` - é™æ€æ’ä»¶å ä½ç¬¦
7. `{{VCPAllTools}}` - å…¨éƒ¨å·¥å…·æè¿°èšåˆ

### 6.3 VCP å·¥å…·è°ƒç”¨åè®®

**è¯·æ±‚æ ¼å¼** (AI è¾“å‡º):
```
<<<[TOOL_REQUEST]>>>
tool_name:ã€Œå§‹ã€PluginNameã€Œæœ«ã€,
param1:ã€Œå§‹ã€value1ã€Œæœ«ã€,
archery:ã€Œå§‹ã€no_replyã€Œæœ«ã€,
ink:ã€Œå§‹ã€mark_historyã€Œæœ«ã€
<<<[END_TOOL_REQUEST]>>>
```

**è§£æä½ç½®**: `modules/vcpLoop/toolCallParser.js`

**é«˜çº§æŒ‡ä»¤**:
| æŒ‡ä»¤ | æ•ˆæœ |
|------|------|
| `archery:ã€Œå§‹ã€no_replyã€Œæœ«ã€` | å¼‚æ­¥æ‰§è¡Œï¼Œä¸ç­‰å¾…ç»“æœ |
| `ink:ã€Œå§‹ã€mark_historyã€Œæœ«ã€` | å¼ºåˆ¶å°†ç»“æœæ³¨å…¥å¯¹è¯å†å² |

---

## 7. åˆ†å¸ƒå¼å·¥å…·æ‰§è¡Œæµç¨‹

### 7.1 èŠ‚ç‚¹æ³¨å†Œæµç¨‹

```
åˆ†å¸ƒå¼èŠ‚ç‚¹å¯åŠ¨
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VCPDistributedServer è¿æ¥åˆ°ä¸»æœåŠ¡å™¨                           â”‚
â”‚ WebSocket è·¯å¾„: /vcp-distributed-server/VCP_Key=xxx          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘é€ register_tools æ¶ˆæ¯                                      â”‚
â”‚ { type: 'register_tools', data: { tools: [...] } }           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WebSocketServer.handleDistributedServerMessage()             â”‚
â”‚ ğŸ“ WebSocketServer.js:407-416                                â”‚
â”‚                                                              â”‚
â”‚ pluginManager.registerDistributedTools(serverId, tools);     â”‚
â”‚ // ä¸ºæ¯ä¸ªå·¥å…·æ·»åŠ  [äº‘ç«¯] å‰ç¼€å’Œ isDistributed: true æ ‡è®°     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘é€ report_ip æ¶ˆæ¯                                          â”‚
â”‚ { type: 'report_ip', data: { localIPs, publicIP, serverName } }â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 å·¥å…·æ‰§è¡Œæµç¨‹

```
AI è¯·æ±‚æ‰§è¡Œäº‘ç«¯å·¥å…·
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PluginManager.processToolCall()                              â”‚
â”‚ ğŸ“ Plugin.js:665-672                                         â”‚
â”‚                                                              â”‚
â”‚ if (plugin.isDistributed) {                                  â”‚
â”‚     result = await this.webSocketServer                      â”‚
â”‚         .executeDistributedTool(plugin.serverId, ...);       â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WebSocketServer.executeDistributedTool()                     â”‚
â”‚ ğŸ“ WebSocketServer.js:467-509                                â”‚
â”‚                                                              â”‚
â”‚ const requestId = generateClientId();                        â”‚
â”‚ pendingToolRequests.set(requestId, { resolve, reject });     â”‚
â”‚ server.ws.send(JSON.stringify({                              â”‚
â”‚     type: 'execute_tool', data: { requestId, toolName, args }â”‚
â”‚ }));                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ†å¸ƒå¼èŠ‚ç‚¹æ‰§è¡Œæœ¬åœ°æ’ä»¶                                        â”‚
â”‚ (VCPDistributedServer å†…éƒ¨)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿”å› tool_result æ¶ˆæ¯                                        â”‚
â”‚ { type: 'tool_result', data: { requestId, status, result } } â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WebSocketServer.handleDistributedServerMessage()             â”‚
â”‚ ğŸ“ WebSocketServer.js:450-460                                â”‚
â”‚                                                              â”‚
â”‚ const pending = pendingToolRequests.get(requestId);          â”‚
â”‚ if (status === 'success') pending.resolve(result);           â”‚
â”‚ else pending.reject(new Error(error));                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 åˆ†å¸ƒå¼æ–‡ä»¶è§£æ (VCPFileAPI v4.0)

ğŸ“ `Plugin.js:726-773`

```
å·¥å…·è°ƒç”¨å‚æ•°å« file:// URL
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœ¬åœ°æ’ä»¶æ‰§è¡Œå¤±è´¥ (FILE_NOT_FOUND_LOCALLY)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FileFetcherServer.fetchFile(fileUrl, requestIp)              â”‚
â”‚ 1. æ ¹æ® IP è¿½è¸ªæ¥æºæœåŠ¡å™¨                                    â”‚
â”‚ 2. é€šè¿‡ WebSocket è¯·æ±‚è¿œç¨‹æ–‡ä»¶                               â”‚
â”‚ 3. è¿”å› Base64 ç¼–ç æ•°æ®                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è‡ªåŠ¨é‡è¯•: æ›¿æ¢ file:// ä¸º data: URI                          â”‚
â”‚ newToolArgs.image_base64_1 = `data:${mimeType};base64,...`   â”‚
â”‚ return await this.processToolCall(toolName, newToolArgs);    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. é”™è¯¯å¤„ç†æœºåˆ¶

### 8.1 è¯·æ±‚ä¸­æ–­æœºåˆ¶

ğŸ“ `server.js:636-745`

```javascript
app.post('/v1/interrupt', (req, res) => {
    const context = activeRequests.get(id);
    if (context) {
        context.aborted = true;
        context.abortController.abort();
        // æ ¹æ®è¯·æ±‚ç±»å‹å‘é€é€‚å½“çš„å“åº”
        if (isStreamRequest) {
            // æµå¼è¯·æ±‚: å‘é€ SSE æ ¼å¼ä¸­æ­¢ä¿¡å·
        } else {
            // éæµå¼è¯·æ±‚: å‘é€ JSON å“åº”
        }
    }
});
```

### 8.2 ä¸Šæ¸¸ API é”™è¯¯å¤„ç†

ğŸ“ `chatCompletionHandler.js:519-569`

```javascript
// æµå¼è¯·æ±‚ä¸Šæ¸¸è¿”å›é 200 çŠ¶æ€ç 
if (isOriginalRequestStreaming && upstreamStatus !== 200) {
    res.status(200);
    res.setHeader('Content-Type', 'text/event-stream');
    // å°†é”™è¯¯ä½œä¸º SSE chunk å‘é€ç»™å®¢æˆ·ç«¯
    res.write(`data: ${JSON.stringify(errorPayload)}\n\n`);
    res.write('data: [DONE]\n\n');
}
```

### 8.3 é‡è¯•æœºåˆ¶

ğŸ“ `chatCompletionHandler.js:99-144`

```javascript
async function fetchWithRetry(url, options, { retries = 3, delay = 1000 }) {
    for (let i = 0; i < retries; i++) {
        const response = await fetch(url, options);
        if (response.status === 500 || response.status === 503 || response.status === 429) {
            await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
            continue; // é‡è¯•
        }
        return response;
    }
    throw new Error('Fetch failed after all retries.');
}
```

### 8.4 IP é»‘åå•æœºåˆ¶

ğŸ“ `server.js:179-289`

```javascript
// é”™è¯¯è®¡æ•°
function handleApiError(req) {
    const currentErrors = (apiErrorCounts.get(clientIp) || 0) + 1;
    if (currentErrors >= MAX_API_ERRORS) {
        ipBlacklist.push(clientIp);
        saveBlacklist();
    }
}

// é»‘åå•æ‹¦æˆªä¸­é—´ä»¶
app.use((req, res, next) => {
    if (ipBlacklist.includes(clientIp)) {
        return res.status(403).json({ error: 'Forbidden' });
    }
    next();
});
```

### 8.5 å·¥å…·æ‰§è¡Œé”™è¯¯æ£€æµ‹

ğŸ“ `chatCompletionHandler.js:19-68`

```javascript
function isToolResultError(result) {
    if (typeof result === 'object') {
        if (result.error === true || result.status === 'error') return true;
    }
    if (typeof result === 'string') {
        const errorPrefixes = ['[error]', '[é”™è¯¯]', '[å¤±è´¥]', 'error:'];
        for (const prefix of errorPrefixes) {
            if (result.toLowerCase().startsWith(prefix)) return true;
        }
    }
    return false;
}
```

---

## 9. å…³é”®è®¾è®¡å†³ç­–

### 9.1 æ‰å¹³åŒ–ç›®å½•ç»“æ„

**å†³ç­–**: æ ¹ç›®å½•ç›´æ¥æ”¾ç½®æ ¸å¿ƒæ¨¡å—ï¼Œæ—  `src/` åˆ†å±‚ã€‚

**ç†ç”±**:
- é™ä½æ¨¡å—å¯¼å…¥å¤æ‚åº¦
- ä¾¿äºå¿«é€Ÿå®šä½ä»£ç 
- é€‚é…æ’ä»¶ç”Ÿæ€çš„æ–‡ä»¶ç›‘å¬éœ€æ±‚

**è¯æ®**: `server.js`ã€`Plugin.js`ã€`WebSocketServer.js` å‡ä½äºæ ¹ç›®å½•

### 9.2 Rust N-API å‘é‡ç´¢å¼•

**å†³ç­–**: ä½¿ç”¨ Rust (USearch) å®ç°å‘é‡ç´¢å¼•ï¼Œé€šè¿‡ N-API ç»‘å®šåˆ° Node.jsã€‚

**ç†ç”±**:
- çº¯ JS å‘é‡æœç´¢æ€§èƒ½ä¸è¶³
- USearch æ˜¯ä¸šç•Œæœ€å¿«çš„å‘é‡æœç´¢å¼•æ“ä¹‹ä¸€
- æ”¯æŒç£ç›˜æ˜ å°„ (mmap) æ¨¡å¼å¤„ç†å¤§è§„æ¨¡æ•°æ®

**è¯æ®**: `KnowledgeBaseManager.js:17-25`
```javascript
try {
    const vexusModule = require('./rust-vexus-lite');
    VexusIndex = vexusModule.VexusIndex;
    console.log('[KnowledgeBase] ğŸ¦€ Vexus-Lite Rust engine loaded');
} catch (e) {
    console.error('[KnowledgeBase] âŒ Critical: Vexus-Lite not found.');
    process.exit(1); // æ—  Rust ç»„ä»¶åˆ™é€€å‡º
}
```

### 9.3 åˆ†å¸ƒå¼æ’ä»¶çƒ­æ³¨å†Œ

**å†³ç­–**: åˆ†å¸ƒå¼èŠ‚ç‚¹é€šè¿‡ WebSocket å®æ—¶æ³¨å†Œæ’ä»¶ï¼Œæ–­å¼€è‡ªåŠ¨æ³¨é”€ã€‚

**ç†ç”±**:
- æ”¯æŒåŠ¨æ€æ‰©ç¼©å®¹
- æ— éœ€é‡å¯ä¸»æœåŠ¡å™¨
- å®ç°ç®—åŠ›åˆ†å¸ƒå¼è°ƒåº¦

**è¯æ®**: `WebSocketServer.js:288-294`
```javascript
ws.on('close', () => {
    if (ws.clientType === 'DistributedServer') {
        pluginManager.unregisterAllDistributedTools(ws.serverId);
        distributedServers.delete(ws.serverId);
    }
});
```

### 9.4 VCP è‡ªå®šä¹‰å·¥å…·è°ƒç”¨åè®®

**å†³ç­–**: ä¸ä½¿ç”¨ OpenAI function-callingï¼Œé‡‡ç”¨è‡ªå®šä¹‰æ–‡æœ¬æ ‡è®°åè®®ã€‚

**ç†ç”±**:
- æ¨¡å‹æ— å…³æ€§ï¼šæ”¯æŒæ‰€æœ‰å…¼å®¹ OpenAI API æ ¼å¼çš„æ¨¡å‹
- åè®®é€æ˜ï¼šæ˜“äºè°ƒè¯•å’Œæ—¥å¿—è¿½è¸ª
- æ”¯æŒé«˜çº§æŒ‡ä»¤ (archery, ink)

**è¯æ®**: README.md - "å·¥å…·è°ƒç”¨åè®®æ˜¯ VCP è‡ªå®šä¹‰å—è¯­æ³•"

### 9.5 é™æ€æ’ä»¶çš„ Cron åˆ·æ–°

**å†³ç­–**: é™æ€æ’ä»¶é€šè¿‡ cron è¡¨è¾¾å¼å®šæ—¶æ‰§è¡Œï¼Œè€ŒéæŒç»­è¿è¡Œã€‚

**ç†ç”±**:
- èµ„æºæ•ˆç‡ï¼šåªåœ¨éœ€è¦æ—¶æ‰§è¡Œ
- çµæ´»è°ƒåº¦ï¼šæ”¯æŒä»»æ„æ—¶é—´é—´éš”
- è¶…æ—¶ä¿æŠ¤ï¼šé¿å…æ— é™æ‰§è¡Œ

**è¯æ®**: `Plugin.js:238-254`
```javascript
if (plugin.refreshIntervalCron) {
    const job = schedule.scheduleJob(plugin.refreshIntervalCron, () => {
        this._updateStaticPluginValue(plugin);
    });
    this.scheduledJobs.set(plugin.name, job);
}
```

### 9.6 å¤šç´¢å¼•éš”ç¦»æ¶æ„

**å†³ç­–**: æ¯ä¸ªæ—¥è®°æœ¬ä½¿ç”¨ç‹¬ç«‹çš„å‘é‡ç´¢å¼•ï¼Œè€Œéå…¨å±€å•ä¸€ç´¢å¼•ã€‚

**ç†ç”±**:
- æ£€ç´¢éš”ç¦»ï¼šé¿å…è·¨æ—¥è®°æœ¬å¹²æ‰°
- æ‡’åŠ è½½ï¼šåªåœ¨è®¿é—®æ—¶åŠ è½½å¯¹åº”ç´¢å¼•
- æ•…éšœéš”ç¦»ï¼šå•ä¸ªç´¢å¼•æŸåä¸å½±å“å…¶ä»–

**è¯æ®**: `KnowledgeBaseManager.js:210-220`
```javascript
async _getOrLoadDiaryIndex(diaryName) {
    if (this.diaryIndices.has(diaryName)) {
        return this.diaryIndices.get(diaryName);
    }
    // æ‡’åŠ è½½ç´¢å¼•
    const idx = await this._loadOrBuildIndex(idxName, 50000, 'chunks', diaryName);
    this.diaryIndices.set(diaryName, idx);
    return idx;
}
```

### 9.7 å¾ªç¯ä¾èµ–è§£å†³ï¼šSetter æ³¨å…¥

**å†³ç­–**: PluginManager â†” WebSocketServer é€šè¿‡è¿è¡ŒæœŸ setter æ³¨å…¥ï¼Œè€Œéæ¨¡å—åŠ è½½æ—¶å¼ºè€¦åˆã€‚

**ç†ç”±**:
- é™ä½æ¨¡å—åŠ è½½æœŸå¾ªç¯å¼•ç”¨é£é™©
- ä¿è¯åˆå§‹åŒ–é¡ºåºå¯æ§
- ä¾¿äºæµ‹è¯•å’Œæ›¿æ¢å®ç°

**è¯æ®**: `server.js:1092`, `server.js:1213`, `WebSocketServer.js:395-398`

---

## é™„å½• A: æ–‡ä»¶å®šä½ç´¢å¼•

| åŠŸèƒ½ | æ–‡ä»¶ | å…³é”®è¡Œå· |
|------|------|----------|
| ç¯å¢ƒåŠ è½½ | `server.js` | 4 |
| æ—¥å¿—åˆå§‹åŒ– | `server.js` | 20-22 |
| Express åˆ›å»º | `server.js` | 231 |
| IP é»‘åå• | `server.js` | 179-303 |
| ç®¡ç†å‘˜è®¤è¯ | `server.js` | 317-456 |
| èŠå¤©ç«¯ç‚¹ | `server.js` | 788-813 |
| ä¸­æ–­ç«¯ç‚¹ | `server.js` | 636-745 |
| æ’ä»¶åŠ è½½ | `Plugin.js` | 388-563 |
| å·¥å…·æ‰§è¡Œ | `Plugin.js` | 632-803 |
| åˆ†å¸ƒå¼è°ƒç”¨ | `Plugin.js` | 665-672 |
| WebSocket åˆå§‹åŒ– | `WebSocketServer.js` | 35-323 |
| åˆ†å¸ƒå¼æ¶ˆæ¯å¤„ç† | `WebSocketServer.js` | 400-465 |
| å‘é‡åº“åˆå§‹åŒ– | `KnowledgeBaseManager.js` | 76-134 |
| TagMemo V3 ç®—æ³• | `KnowledgeBaseManager.js` | 443-731 |
| å¯¹è¯ä¸»æµç¨‹ | `chatCompletionHandler.js` | 254-712 |
| å˜é‡æ›¿æ¢ | `messageProcessor.js` | 14-239 |

---

## é™„å½• B: é…ç½®æ–‡ä»¶ä¾èµ–

| é…ç½®æ–‡ä»¶ | ç”¨é€” | åŠ è½½ä½ç½® |
|----------|------|----------|
| `config.env` | å…¨å±€ç¯å¢ƒå˜é‡ | `server.js:4` |
| `Plugin/*/config.env` | æ’ä»¶ç§æœ‰é…ç½® | `Plugin.js:442-446` |
| `Plugin/*/plugin-manifest.json` | æ’ä»¶æ¸…å• | `Plugin.js:435` |
| `preprocessor_order.json` | é¢„å¤„ç†å™¨é¡ºåº | `Plugin.js:484-496` |
| `ip_blacklist.json` | IP é»‘åå• | `server.js:179-193` |
| `Agent/agent_map.json` | Agent åˆ«åæ˜ å°„ | `agentManager.js` |
| `rag_params.json` | RAG çƒ­è°ƒæ§å‚æ•° | `KnowledgeBaseManager.js:140-149` |

---

## é™„å½• C: è¾¹ç•Œæ¡ä»¶ä¸å¼‚å¸¸åˆ†æ”¯

- Agent ç›®å½•åˆ›å»ºå¤±è´¥ -> è¿›ç¨‹é€€å‡º ğŸ“ `server.js:49-65`
- Admin å‡­æ®ç¼ºå¤± -> ç®¡ç†é¢æ¿ç¦ç”¨ï¼ˆ503ï¼‰ğŸ“ `server.js:345-357`
- ç™»å½•æš´åŠ›å°è¯• -> ä¸´æ—¶å°ç¦ + Retry-After ğŸ“ `server.js:361-369`
- åˆ†å¸ƒå¼ç›®æ ‡èŠ‚ç‚¹ç¦»çº¿ -> æŠ›é”™ç»ˆæ­¢å·¥å…·è°ƒç”¨ ğŸ“ `WebSocketServer.js:485-487`
- åˆ†å¸ƒå¼å·¥å…·è¶…æ—¶ -> pending æ¸…ç† + reject ğŸ“ `WebSocketServer.js:500-503`
- æ’ä»¶ stdout éæ³• JSON -> åŒæ­¥æ’ä»¶æŒ‰å¤±è´¥åˆ†æ”¯è¿”å›è¯¦ç»†é”™è¯¯ ğŸ“ `Plugin.js:999-1013`
- ä¸Šæ¸¸æµå¼å¼‚å¸¸ -> SSE é”™è¯¯å¸§å…œåº• ğŸ“ `chatCompletionHandler.js:619-651`

---

*æ–‡æ¡£ç»“æŸ*
